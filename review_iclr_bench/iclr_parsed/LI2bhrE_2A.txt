# ITERATIVE REFINEMENT GRAPH NEURAL NETWORK
## FOR ANTIBODY SEQUENCE-STRUCTURE CO-DESIGN

**Wengong Jin[†], Jeremy Wohlwend[*], Regina Barzilay[*], Tommi Jaakkola[*]**

† Eric and Wendy Schmidt Center, Broad Institute of MIT and Harvard

-  CSAIL, Massachusetts Institute of Technology
_{wengong,jwohlwend,regina,tommi}@csail.mit.edu_

ABSTRACT

Antibodies are versatile proteins that bind to pathogens like viruses and stimulate
the adaptive immune system. The specificity of antibody binding is determined
by complementarity-determining regions (CDRs) at the tips of these Y-shaped
proteins. In this paper, we propose a generative model to automatically design
the CDRs of antibodies with enhanced binding specificity or neutralization capabilities. Previous generative approaches formulate protein design as a structureconditioned sequence generation task, assuming the desired 3D structure is given
a priori. In contrast, we propose to co-design the sequence and 3D structure of
CDRs as graphs. Our model unravels a sequence autoregressively while iteratively refining its predicted global structure. The inferred structure in turn guides
subsequent residue choices. For efficiency, we model the conditional dependence
between residues inside and outside of a CDR in a coarse-grained manner. Our
method achieves superior log-likelihood on the test set and outperforms previous
baselines in designing antibodies capable of neutralizing the SARS-CoV-2 virus[1].

1 INTRODUCTION

Monoclonal antibodies are increasingly adopted as therapeutics targeting a wide range of pathogens
such as SARS-CoV-2 (Pinto et al., 2020). Since the binding specificity of these Y-shaped proteins is
largely determined by their complementarity-determining regions (CDRs), the main goal of computational antibody design is to automate the creation of CDR subsequences with desired properties.
This problem is particularly challenging due to the combinatorial search space of over 20[60] possible CDR sequences and the small solution space which satisfies the desired constraints of binding
affinity, stability, and synthesizability (Raybould et al., 2019).

There are three key modeling questions in CDR generation. The first is how to model the relation
between a sequence and its underlying 3D structure. Generating sequences without the corresponding structure (Alley et al., 2019; Shin et al., 2021) can lead to sub-optimal performance (Ingraham
et al., 2019), while generating from a predefined 3D structure (Ingraham et al., 2019) is not suitable for antibodies since the desired structure is rarely known a priori (Fischman & Ofran, 2018).
Therefore, it is crucial to develop models that co-design the sequence and structure. The second
question is how to model the conditional distribution of CDRs given the remainder of a sequence
(context). Attention-based methods only model the conditional dependence at the sequence level,
but the structural interaction between the CDR and its context is crucial for generation. The last
question relates to the model’s ability to optimize for various properties. Traditional physics-based
methods (Lapidoth et al., 2015; Adolf-Bryfogle et al., 2018) focus on binding energy minimization,
but in practice, our objective can be much more involved than binding energies (Liu et al., 2020).

In this paper, we represent a sequence-structure pair as a graph and formulate the co-design task as
a graph generation problem. The graph representation allows us to model the conditional dependence between a CDR and its context at both the sequence and structure levels. Antibody graph
generation poses unique challenges because the global structure is expected to change when new
nodes are inserted. Previous autoregressive models (You et al., 2018; Gebauer et al., 2019) cannot

[1Our code is available at https://github.com/wengong-jin/RefineGNN](https://github.com/wengong-jin/RefineGNN)


-----

modify a generated structure because they are trained under teacher forcing. Thus errors made in
the previous steps can lead to a cascade of errors in subsequent generation steps. To address these
problems, we propose a novel architecture which interleaves the generation of amino acid nodes
with the prediction of 3D structures. The structure generation is based on an iterative refinement of
a global graph rather than a sequential expansion of a partial graph with teacher forcing. Since the
context sequence is long, we further introduce a coarsened graph representation by grouping nodes
into blocks. We apply graph convolution at a coarser level to efficiently propagate the contextual
information to the CDR residues. After pretraining our model on antibodies with known structures,
we finetune it using a predefined property predictor to generate antibodies with specific properties.

We evaluate our method on three generation tasks, ranging from language modeling to SARS-CoV-2
neutralization optimization and antigen-binding antibody design. Our method is compared with a
standard sequence model (Saka et al., 2021; Akbar et al., 2021) and a state-of-the-art graph generation method (You et al., 2018) tailored to antibodies. Our method not only achieves lower perplexity
on test sequences but also outperforms previous baselines in property-guided antibody design tasks.

2 RELATED WORK

**Antibody/protein design. Current methods for computational antibody design roughly fall into two**
categories. The first class is based on energy function optimization (Pantazes & Maranas, 2010; Li
et al., 2014; Lapidoth et al., 2015; Adolf-Bryfogle et al., 2018), which use Monte Carlo simulation
to iteratively modify a sequence and its structure until reaching a local energy minimum. Similar
approaches are used in protein design (Leaver-Fay et al., 2011; Tischer et al., 2020). Nevertheless,
these physics-based methods are computationally expensive (Ingraham et al., 2019) and our desired
objective can be much more complicated than low binding energy (Liu et al., 2020).

The second class is based on generative models. For antibodies, they are mostly sequence-based
(Alley et al., 2019; Shin et al., 2021; Saka et al., 2021; Akbar et al., 2021). For proteins, O’Connell
et al. (2018); Ingraham et al. (2019); Strokach et al. (2020); Karimi et al. (2020); Cao et al. (2021)
further developed models conditioned on a backbone structure or protein fold. Our model also seeks
to incorporate 3D structure information for antibody generation. Since the best CDR structures are
often unknown for new pathogens, we co-design sequences and structures for specific properties.

**Generative models for graphs. Our work is related to autoregressive models for graph generation**
(You et al., 2018; Li et al., 2018; Liu et al., 2018; Liao et al., 2019; Jin et al., 2020a). In particular,
Gebauer et al. (2019) developed G-SchNet for molecular graph and conformation co-design. Unlike
our method, they generate edges sequentially and cannot modify a previously generated subgraph
when new nodes arrive. While Graphite (Grover et al., 2019) also uses iterative refinement to predict
the adjacency matrix of a graph, it assumes all the node labels are given and predicts edges only. In
contrast, our work combines autoregressive models with iterative refinement to generate a full graph
with node and edge labels, including node labels and coordinates.

**3D structure prediction. Our approach is closely related to protein folding (Ingraham et al., 2018;**
Yang et al., 2020a; Baek et al., 2021; Jumper et al., 2021). Inputs to the state-of-the-art models
like AlphaFold require a complete protein sequence, its multi-sequence alignment (MSA), and its
template features. These models are not directly applicable because we need to predict the structure
of an incomplete sequence and the MSA is not specified in advance.

Our iterative refinement model is also related to score matching methods for molecular conformation
prediction (Shi et al., 2021) and diffusion-based methods for point clouds (Luo & Hu, 2021). These
algorithms also iteratively refine a predicted 3D structure, but only for a complete molecule or
point cloud. In contrast, our approach learns to predict the 3D structure for incomplete graphs and
interleaves 3D structure refinement with graph generation.

3 ANTIBODY SEQUENCE AND STRUCTURE CO-DESIGN

**Overview. The role of an antibody is to bind to an antigen (e.g. a virus), present it to the immune**
system, and stimulate an immune response. A subset of antibodies known as neutralizing antibodies
not only bind to an antigen but can also suppress its activity. An antibody consists of a heavy chain
and a light chain, each composed of one variable domain (VH/VL) and some constant domains. The


-----

Each tokenNotations. An antibody VH domain is represented as a sequence of amino acids si in the sequence is called a residue, whose value can be either one of the 20 amino acids s = s1s2 · · · sn.

Antibody sequence

Heavy chain variable region (VH) CDR-H1 CDR-H2Heavy chain CDR-H3

Antibody

Light chain variable region (VL) CDR-L1 CDR-L2 CDR-L3 structure

Figure 1: Schematic structure of an antibody (figure modified from Wikipedia).

variable domain is further divided into a framework region and three complementarity determining
_regions (CDRs). The three CDRs on the heavy chain are labeled as CDR-H1, CDR-H2, CDR-H3,_
each occupying a contiguous subsequence (Figure 1). As the most variable part of an antibody,
CDRs are the main determinants of binding and neutralization (Abbas et al., 2014).

Following Shin et al. (2021); Akbar et al. (2021), we formulate antibody design as a CDR generation
task, conditioned on the framework region. Specifically, we represent an antibody as a graph, which
encodes both its sequence and 3D structure. We propose a new graph generation approach called
RefineGNN and extend it to handle conditional generation given a fixed framework region. Lastly,
we describe how to apply RefineGNN to property-guided optimization to design new antibodies with
better neutralization properties. For simplicity, we focus on the generation of heavy chain CDRs,
though our method can be easily extended to model light chains CDRs.

or a special token ⟨MASK⟩, meaning that its amino acid type is unknown and needs to be predicted.
The VH sequence folds into a 3D structure and each residue si is labeled with three backbone
coordinates: xi,α for its alpha carbon atom, xi,c for its carbon atom, and xi,n for its nitrogen atom.

3.1 GRAPH REPRESENTATION

We represent an antibody (VH) as a graph (s) = ( _,_ ) with node features = **_v1,_** _, vn_ and
_G_ _V_ _E_ _V_ _{_ _· · ·_ _}_
edge features = **_eij_** _i=j. Each node feature vi encodes three dihedral angles (φi, ψi, ωi) related_
_E_ _{_ _}_ _̸_
to three backbone coordinates of residue i. For each residue i, we compute an orientation matrix
**_Oi representing its local coordinate frame (Ingraham et al., 2019) (defined in the appendix). This_**
allows us to compute edge features describing the spatial relationship between two residues i and j:

**_xj,α_** **_xi,α_**
**_eij =_** _Epos(i_ _j),_ RBF( **_xi,α_** **_xj,α_** ), **_Oi[⊤]_** _−_ **_q(Oi[⊤][O][j][)]_** _._ (1)
_−_ _∥_ _−_ _∥_ **_xi,,α_** **_xj,,α_**

_∥_ _−_ _∥_ _[,]_

  

The edge feature eij contains four parts. The positional encoding Epos(i − _j) encodes the relative_
distance between two residues in an antibody sequence. The second term RBF(·) is a distance
encoding lifted into radial basis. The third term in eij is a direction encoding that corresponds to
the relative direction of xj in the local frame of residue i. The last term q(Oi[⊤][O][j][)][ is the][ orientation]
encoding of the quaternion representation q(·) of the spatial rotation matrix Oi[⊤][O][j][. We only include]
edges in the K-nearest neighbors graph of G(s) with K = 8. For notation convenience, we use G
as a shorthand for G(s) when there is no ambiguity.

3.2 ITERATIVE REFINEMENT GRAPH NEURAL NETWORK (REFINEGNN)


We propose to generate an antibody graph via an iterative refinement process. Let G[(0)] be the initial
guess of the true antibody graph. Each residue is initialized as a special token ⟨MASK⟩ and each edge
(i, j) is initialized to be of distance 3|i − _j| since the average distance between consecutive residues_
is around three. The direction and orientation features are set to zero. In each generation step t, the
model learns to revise a current antibody graph G[(][t][)] and predict the label of the next residue t + 1.
Specifically, it first encodes G[(][t][)] with a message passing network (MPN) with parameter θ

_{h1[(][t][)][,][ · · ·][,][ h][(]n[t][)][}][ = MPN][θ][(][G][(][t][)][)][,]_ (2)

where h[(]i[t][)] is a learned representation of residue i under the current graph . Our MPN consists
_G[(][t][)]_
of L message passing layers with the following architecture

**_h[(]i[t,l][+1)]_** = LayerNorm FFN **_h[(]i[t,l][)], h[(]j[t,l][)], E(sj), ei,j_** _,_ 0 _l_ _L_ 1, (3)

_≤_ _≤_ _−_
_j_

 X   []


-----

where h[(]i[t,][0)] = vi and h[(]i[t][)] = h[(]i[t,L][)]. FFN is a two-layer feed-forward network (FFN) with ReLU
activation function. E(sj) is a learned embedding of amino acid type sj. Based on the learned
residue representations, we predict the amino acid type of the next residue t + 1 (Figure 2A).

**_pt+1 = softmax(Wah[(]t+1[t][)]_** [)] (4)

This prediction gives us a new graph G[(][t][+0][.][5)] with the same edges as G[(][t][)] but the node label of t + 1
is changed (Figure 2B). Next, we need to update the structure to accommodate the new residue t +1.
To this end, we encode graph G[(][t][+0][.][5)] by another MPN with a different parameter _θ[˜] and predict the_
coordinate of all residues.

_{h[(]1[t][+0][.][5)], · · ·, h[(]n[t][+0][.][5)]}_ = MPNθ˜[(][G][(][t][+0][.][5)][)] (5)

**_x[(]i,e[t][+1)]_** = **_Wx[e][h][(]i[t][+0][.][5)],_** 1 _i_ _n, e_ _α, c, n_ _._ (6)
_≤_ _≤_ _∈{_ _}_

The new coordinates x[(]i[t][+1)] define a new antibody graph for the next iteration (Figure 2C).
_G[(][t][+1)]_
We explicitly realize the coordinates of each residue because we need to calculate the spatial edge
features for . The structure prediction (coordinates xi) and sequence prediction (amino acid
_G[(][t][+1)]_
types pt+1) are carried out by two different MPNs, namely the structure network _θ[˜] and sequence_
network θ. This disentanglement allows the two networks to focus on two distinct tasks.

**Training. During training, we only apply teacher forcing to the discrete amino acid type prediction.**
Specifically, in each generation step t, residues 1 to t are set to their ground truth amino acid types
**_s1,_** _, st, while all future residues t + 1,_ _, n are set to a padding token. In contrast, the contin-_
_· · ·_ _· · ·_
uous structure prediction is carried out without teacher forcing. In each iteration, the model refines
the entire structure predicted in the previous step and constructs a new K-nearest neighbors graph
of all residues based on the predicted coordinates **_x[(]i,e[t][+1)]_** 1 _i_ _n, e_ _α, c, n_ .
_G[(][t][+1)]_ _{_ _|_ _≤_ _≤_ _∈{_ _}}_

**Loss function. Our model remains rotation and translation invariant because the loss function is**
computed over pairwise distance and angles rather than coordinates. The loss function for antibody
structure prediction consists of three parts.

-  Distance loss: For each residue pair i, j, we compute its pairwise distance between the predicted
alpha carbons x[(]i,α[t][)] _[,][ x][(]j,α[t][)]_ [. We define the distance loss as the Huber loss between the predicted and]
true pairwise distances

_Ld[(][t][)]_ = _i,j_ _[ℓ][huber][(][∥][x][(]i,α[t][)]_ _[−]_ **_[x]j,α[(][t][)]_** _[∥][2][,][ ∥][x][i,α][ −]_ **_[x][j,α][∥][2][)][,]_** (7)
X

where distance is squared to avoid the square root operation which causes numerical instability.

-  Dihedral angle loss: For each residue, we calculate its dihedral angle _φ[(]i[t][)][, ψ]i[(][t][)][, ω]i[(][t][)]_ based on
the predicted atom coordinates x[(]i,α[t][)] _[,][ x][(]i,c[t][)][,][ x][(]i,n[t][)]_ [and][ x][(]i+1[t][)] _,α[,][ x][(]i+1[t][)]_ _,c[,][ x][(]i+1[t][)]_  ,n[. We define the dihedral]
angle loss as the mean square error between the predicted and true dihedral angles


_i_ cos ai)[2] + (sin a[(]i[t][)] sin ai)[2] (8)
_a_ _φ,ψ,ω_ _−_ _−_
_∈{_ _}[(cos][ a][(][t][)]_


_a_
_L[(][t][)]_



-  Cα angle loss: We calculate angles γi[(][t][)] between two vectors x[(]i[t][)]1,α _i,α_ [and][ x][(]i,α[t][)] _i+1,α_ [as]
_−_ _[−]_ **_[x][(][t][)]_** _[−]_ **_[x][(][t][)]_**

well as dihedral angles βi[(][t][)] between two planes defined by x[(]i[t][)]2,α[,][ x][(]i[t][)]1,α[,][ x][(]i,α[t][)] _[,][ x][(]i+1[t][)]_ _,α[.]_
_−_ _−_


_i_ cos γi)[2] + (cos βi[(][t][)] cos βi)[2] (9)
_i[(cos][ γ][(][t][)]_ _−_ _−_


_c_
_L[(][t][)]_


In summary, the overall graph generation loss is defined as L = Lseq + Lstruct, where


_Lstruct =_ _t_ _[L]d[(][t][)]_ [+][ L][(]a[t][)] [+][ L][(]c[t][)] _Lseq =_ _t_ _[L][ce][(][p][t][,][ s][t][)][.]_ (10)

The sequence prediction lossX Lseq is the cross entropy Lce between predicted and true residue types.X

3.3 CONDITIONAL GENERATION GIVEN THE FRAMEWORK REGION

The model architecture described so far is designed for unconditional generation — it generates an
entire antibody graph without any constraints. In practice, we usually fix the framework region of an


-----

|l r|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|Col17|Col18|Col19|Col20|Col21|Col22|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|AQKF|QGKA|TLTA|DKSS|KTVY|MHLSS|LAS|EDSA|VYYC|||||C|DR|-H3||||WGQG|TSVT||


**A** D **B** D **C** D

G Predict G Y

amino acid Y G

R R R

Predict all

Message coordinates

A passing A A

Update Update

sequence structure Coarsened _s>r_

VYYC WGQG VYYC WGQG VYYC context sequenceWGQG
…SA …VT …SA …VT _s<l_ …SA …VT

𝒢[(][t][)] 𝒢[(][t][+0.5)] 𝒢[(][t][+1)]

**D** Original sequence :s …TIYPGDGDTGYAQKFQGKATLTADKSSKTVYMHLSSLASEDSAVYYCARGDYYGSNSLDYWGQGTSVT…

_l_ _r_

Context sequence bl,r(s): … AQKF QGKA TLTA DKSS KTVY MHLS SLAS EDSA VYYC CDR-H3 WGQG TSVT …

Figure 2: (A-C) One generation step of RefineGNN. Each circle represents a CDR residue and each
square represents a residue block in a coarsened context sequence. (D) Sequence coarsening.


antibody and design the CDR sequence only. Therefore, we need to extend the model architecture to
learn the conditional distribution P (s[′] **_s<l, s>r), where s<l = s1_** **_sl_** 1 and s>r = sr+1 **_sn_**
are residues outside of the CDR sl **_s|_** _r._ _· · ·_ _−_ _· · ·_
_· · ·_

**Conditioning via attention. A simple extension of RefineGNN is to encode the non-CDR se-**
quence using a recurrent neural network and propagate information to the CDR through an attention layer. To be specific, we first concatenate s<l and s>r into a context sequence ˜s =
**_s<l_** `MASK` `MASK` **_s>r, where_** means string concatenation and `MASK` is repeated n
times. We then encode this context sequence by a Gated Recurrent Unit (GRU) (Cho et al., 2014) ⊕⟨ _⟩· · · ⟨_ _⟩⊕_ _⊕_ _⟨_ _⟩_
and modify the structure and sequence prediction step (Equation 4 and 6) as

_{c1, · · ·, cn}_ = **_c1:n = GRU(˜s)_** (11)

**_pt+1_** = softmax **_Wah[(]t+1[t][)]_** [+][ U][ ⊤]a [attention(][c][1:][n][,][ h][(]t+1[t][)] [)] (12)

**_x[(]i,e[t][+1)]_** = **_Wx[e][h][(]i[t][+0] [.][5)]_** + Ux[e]⊤attention(c1:n, h[(]i[t][+0][.][5)])  (13)

**Multi-resolution modeling. The attention-based approach alone is not sufficient because it does**
not model the structure of the context sequence, thus ignoring how its residues structurally interact
with the CDR’s. While this information is not available for new antibodies at test time, we can learn
to predict this interaction using antibodies in the training set with known structures.

A naive solution is to iteratively refine the entire antibody structure (more than 100 residues) while
generating CDR residues. This approach is computationally expensive because we need to recompute the MPN encoding for all residues in each generation step. Importantly, we cannot predict the
context residue coordinates at the outset and fix them because they need to be adjusted accordingly
when the coordinates of CDR residues are updated in each generation step.

For computational efficiency, we propose a coarse-grained model that reduces the context sequence
length by clustering it into residue blocks. Specifically, we construct a coarsened context sequence
**_bl,r(s) by clustering every b context residues into a block (Figure 2D). The new sequence bl,r(s)_**
defines a coarsened graph (bl,r(s)) over the residue blocks, whose edges are defined based on
_G_
block coordinates. The coordinate of each block xbi,e is defined as the mean coordinate of residues
within the block. The embedding of each block E(bi) is the mean of its residue embeddings.

_E(bi) =_ **_xbi,e =_** _e_ _α, c, n_ _._ (14)

**_sj_** **_bi_** _[E][(][s][j][)][/b,]_ **_sj_** **_bi_** **_[x][j,e][/b,]_** _∈{_ _}_
_∈_ _∈_

X X

Now we can apply RefineGNN to generate the CDR residues while iteratively refining the global
graph (bl,r(s)) by predicting the coordinates of all blocks. The only change is that the structure
_G_
prediction loss is defined over block coordinatesanism and coarse-grained modeling to keep both fine-grained and coarse-grained information. The xbi,e. Lastly, we combine both the attention mechdecoding process of this conditional RefineGNN is illustrated in Algorithm 1.


-----

**Algorithm 2 ITA-based sequence optimization**

**Require: A set of antibodies D to be optimized**
**Require: A neutralization predictor f** .
**Require: A set of neutralizing antibodies Q**

1: for each iteration do
2: Sample an antibody s from D, remove its
CDR and get a context sequence bl,r(s)

3: **for i = 1 to M do**

4: Sample s[′]i

5: **if f** (s[′]i[)][ >][ max(][∼] _[P][Θ][f][(][s][(][s][′][|][)][b][,][l,r][ 0][.][(][5)][s][))][ then]_

6: _Q ←_ _Q ∪{s[′]i[}]_

7: Sample a batch of new antibodies from Q

8: Update model parameter Θ by minimizing
the sequence prediction loss seq.
_L_


**Algorithm 1 RefineGNN decoding**

**Require: Context sequence s<l, s>r**

1: Predict the CDR length n
2: Coarsen the context sequence into bl,r(s)
3: Construct the initial graph G[(0)]

4: for t = 0 to n − 1 do
5: Encode G[(][t][)] using the sequence MPN

6: Predict distribution of the next residue
**_pt+1_**

7: Sample st+1 categorical(pt+1)
_∼_

8: Encode G[(][t][+0][.][5)] with the structure MPN

9: Predict all residue coordinates x[(]i,e[t][+1)]

10: Update G[(][t][+1)] using the new coordinates


3.4 PROPERTY-GUIDED SEQUENCE OPTIMIZATION

Our ultimate goal is to generate new antibodies with desired properties such as neutralizing a particular virus. This task can be formulated as an optimization problem. Let Y be a binary indicator
variable for neutralization. Our goal is to learn a conditional generative model PΘ(s[′] **_bl,r(s)) that_**
_|_
maximizes the probability of neutralization for a training set of antibodies D, i.e.

(15)

**_s_** [log][ P] [(][Y][ = 1][|][b][l,r][(][s][)) =] **_s_** [log] **_s[′][ f]_** [(][s][′][)][P][Θ][(][s][′][|][b][l,r][(][s][))]
_∈D_ _∈D_

where f (s[′]) is a predictor forX _P_ (Y = 1|s[′]). AssumingX _fX is given, this problem can be solved_
by iterative target augmentation (ITA) (Yang et al., 2020b). Before ITA optimization starts, we
first pretrain our model on a set of real antibody structures to learn a prior distribution over CDR
sequences and structures. In each ITA finetuning step, we first randomly sample a sequence s from
_D, a set of antibodies whose CDRs need to be redesigned. Next, we generate M new sequences_
given its context bl,r(s). A generated sequence s[′]i [is added to our training set][ Q][ if it is predicted as]
neutralizing. Initially, the training set Q contains antibodies that are known to be neutralizing (Y =
1). Lastly, we sample a batch of neutralizing antibodies from Q and update the model parameter
by minimizing their sequence prediction loss Lseq (Eq.(10)). The structure prediction loss Lstruct is
excluded in ITA finetuning phase because the structure of a generated sequence is unknown.


4 EXPERIMENTS

**Setup. We construct three evaluation setups to quantify the performance of our approach. Following**
standard practice in generative model evaluation, we first measure the perplexity of different models
on new antibodies in a test set created based on sequence similarity split. We also measure structure
prediction error by comparing generated and ground truth CDR structures recorded in the Structural
Antibody Database (Dunbar et al., 2014). Results for this task are shown in section 4.1.

Second, we evaluate our method on an existing antibody design benchmark of 60 antibody-antigen
complexes from Adolf-Bryfogle et al. (2018). The goal is to design the CDR-H3 of an antibody so
that it binds to a given antigen. Results for this task are shown in section 4.2.

Lastly, we propose an antibody optimization task which aims to redesign CDR-H3 of antibodies in
the Coronavirus Antibody Database (Raybould et al., 2021) to improve their neutralization against
SARS-CoV-2. CDR-H3 design with a fixed framework is a common practice in the antibody engineering community (Adolf-Bryfogle et al., 2018; Liu et al., 2020). Following works in molecular
design (Jin et al., 2020b), we use a predictor to evaluate the neutralization of generated antibodies
since we cannot experimentally test them in wet labs. Results for this task are reported in section 4.3.

**Baselines. We consider three baselines for comparison (details in the appendix). The first baseline**
is a sequence-based LSTM model used in Saka et al. (2021); Akbar et al. (2021). This model does
not utilize any 3D structure information. It consists of an encoder that learns to encode a context
sequence ˜s, a decoder that decodes a CDR sequence, and an attention layer connecting the two.


-----

Table 1: Left: Language modeling results. We report perplexity (PPL) and root mean square deviation (RMSD) for each CDR in the heavy chain. Right: Results on the antigen-binding antibody
design task. We report the amino acid recovery (AAR) for all methods.


CDR-H1 CDR-H2 CDR-H3

Model PPL RMSD PPL RMSD PPL RMSD

LSTM 6.79 -  7.21 -  9.70 - 
AR-GNN 6.44 2.97 6.86 2.27 9.44 3.63

RefineGNN **6.09** **1.18** **6.58** **0.87** **8.54** **2.50**


Model AAR

RAbD 28.53%

LSTM 22.53%
AR-GNN 23.86%

RefineGNN **34.14%**


The second baseline is an autoregressive graph generation model (AR-GNN) whose architecture is
similar to You et al. (2018); Jin et al. (2020b) but tailored for antibodies. AR-GNN generates an
antibody graph residue by residue. In each step t, it first predicts the amino acid type of residue t
and then generates edges between t and previous residues. Importantly, AR-GNN cannot modify a
partially generated 3D structure of residues s1 **_st_** 1 because it is trained by teacher forcing.
_· · ·_ _−_

On the antigen-binding task, we include an additional physics-based baseline called RosettaAntibodyDesign (RAbD) (Adolf-Bryfogle et al., 2018). We apply their de novo design protocol composed of graft design followed by 250 iterations of sequence design and energy minimization. We
cannot afford to run more iterations because it takes more than 10 hours per antibody. We also
could not apply RAbD to the SARS-CoV-2 task because it requires 3D structures to be given. This
information is unavailable for antibodies in CoVAbDab.

**Hyperparameters. We performed hyperparameter tuning to find the best setting for each method.**
For RefineGNN, both its structure and sequence MPN have four message passing layers, with a
hidden dimension of 256 and block size b = 4. All models are trained by the Adam optimizer with
a learning rate of 0.001. More details are provided in the appendix.

4.1 LANGUAGE MODELING AND 3D STRUCTURE PREDICTION

**Data. The Structural Antibody Database (SAbDab) consists of 4994 antibody structures renumbered**
according to the IMGT numbering scheme (Lefranc et al., 2003). To measure a model’s ability to
generalize to novel CDR sequences, we divide the heavy chains into training, validation, and test sets
based on CDR cluster split. We illustrate our cluster split process using CDR-H3 as an example.
First, we use MMseqs2 (Steinegger & S¨oding, 2017) to cluster all the CDR-H3 sequences. The
sequence identity is calculated under the BLOSUM62 substitution matrix (Henikoff & Henikoff,
1992). Two antibodies are put into the same cluster if their CDR-H3 sequence identity is above
40%. We then randomly split the clusters into training, validation, and test set with 8:1:1 ratio. We
repeat the same procedure for creating CDR-H1 and CDR-H2 splits. In total, there are 1266, 1564,
and 2325 clusters for CDR-H1, H2, and H3. The size of training, validation, and test sets for each
CDR is shown in the appendix.

**Metrics. For each method, we report the perplexity (PPL) of test sequences and the root mean**
square deviation (RMSD) between a predicted structure and its ground truth structure reported in
SAbDab. RMSD is calculated by the Kabsch algorithm (Kabsch, 1976) based on Cα coordinate of
CDR residues. Since the mapping between sequences and structures is deterministic in RefineGNN,
we can calculate perplexity in the same way as standard sequence models.

**Results. Since the LSTM baseline does not involve structure prediction, we report RMSD for graph-**
based methods only. As shown in Table 1, RefineGNN significantly outperforms all baselines in
both metrics. For CDR-H3, our model gives 13% PPL reduction (8.54 v.s. 9.70) over sequence only
model and 10% PPL reduction over AR-GNN (8.54 v.s. 9.44). RefineGNN also predicts the structure more accurately, with 30% relative RMSD reduction over AR-GNN. In Figure 3, we provide
examples of predicted 3D structures of CDR-H3 loops.

**Ablation studies. We further conduct ablation experiments on the CDR-H3 generation task to study**
the importance of different modeling choices. First, when we remove the attention mechanism and
context coarsening step in section 3.3, the PPL increases from 8.54 to 8.86 (Figure 3C, row 2) and
9.01 (Figure 3C, row 3) respectively. We also tried to remove both the attention and coarsening


-----

|Col1|7.|39|8.54 8.86 9.01 8.95|
|---|---|---|---|


**A** **B** **C**

RefineGNN 8.54

No attention 8.86

CDR-H3 CDR-H3

No coarsening 9.01

Unconditional 8.95

Structure- 7.39

conditioned

Ground truth Ground truth

5 6 7 8 9

RefineGNN AR-GNN

CDR-H3 Perplexity

Figure 3: (A) CDR-H3 structure predicted by RefineGNN (PDB: 4bkl, RMSD = 0.57). The predicted structure (cyan) is aligned to the true structure (green) using the Kabsch algorithm. (B) CDRH3 structure predicted by AR-GNN (PDB: 4bkl, RMSD = 2.16). (C) Ablation studies of different
modeling choices in RefineGNN in the CDR-H3 perplexity evaluation task.

modules and trained the model without conditioning on the context sequence. The PPL of this

unconditional variant is much worse than our conditional model (Figure 3C, row 4). Lastly, we
train a structure-conditioned model by feeding the ground truth structure to RefineGNN at every
generation step (Figure 3C, row 5). While this structure-conditioned model gives a lower PPL as
expected (7.39 v.s. 8.54), it is not too far away from the sequence only model (PPL = 9.70). This
suggests that RefineGNN is able to extract a decent amount of information from the partial structure
co-evolving with the sequence.

4.2 ANTIGEN-BINDING ANTIBODY DESIGN

**Data. Adolf-Bryfogle et al. (2018) selected 60 antibody-antigen complexes as an antibody design**
benchmark. Given the framework of an antibody, the goal is to design its CDR-H3 that binds to its
corresponding antigen. For simplicity, none of the methods is conditioned on the antigen structure
during CDR-H3 generation. We leave antigen-conditioned CDR generation for future work.

**Metric. Following Adolf-Bryfogle et al. (2018), we use amino acid recovery (AAR) as the evalu-**
ation metric. For any generated sequence, we define its AAR as the percentage of residues having
the same amino acid as the corresponding residue in the original antibody.

**Results. For LSTM, AR-GNN, and RefineGNN, the training set in this setup is the entire SAbDab**
except antibodies in the same cluster as any of the test antibodies. At test time, we generate 10000
CDR-H3 sequences for each antibody and select the top 100 candidates with the lowest perplexity.
For simplicity, all methods are configured to generate CDRs of the same length as the original
CDR. As shown in Table 1, our model achieves the highest AAR score, with around 7% absolute
improvement over the best baseline. In Figure 4A, we show an example of a generated CDRH3 sequence and highlight residues that are different from the original antibody. We also found
that sequences with lower perplexity tend to have a lower AA recovery error (Pearson R = 0.427,
Figure 4B). This suggests that we can use perplexity as the ranking criterion for antibody design.

4.3 SARS-COV-2 NEUTRALIZATION OPTIMIZATION

**Data. The Coronavirus Antibody Database (CoVAbDab) contains 2411 antibodies, each associ-**
ated with multiple binary labels indicating whether it neutralizes a coronavirus (SARS-CoV-1 or
SARS-CoV-2) at a certain epitope. Similar to the previous experiment, we divide the antibodies into
training, validation, and test sets based on CDR-H3 cluster split with 8:1:1 ratio.

**Neutralization predictor. The predictor takes as input the VH sequence of an antibody and out-**
puts a neutralization probability for the SARS-CoV-1 and SARS-CoV-2 viruses. Each residue is
embedded into a 64 dimensional vector, which is fed to a SRU encoder (Lei, 2021) followed by
average-pooling and a two-layer feed forward network. The final outputs are the probabilities p1


-----

Figure 4: (A) Visualization of a generated CDR-H3 sequence and its structure in complex with an
antigen (PDB: 4cmh). The predicted structure is aligned and grafted onto the original antibody using
the Kabsch algorithm. Residues different from the original antibody are highlighted in red. (B) The
correlation between the perplexity of a generated sequence and AA recovery error.

Table 2: SARS-CoV-2 neutralization optimization results. For each method, we report the PPL on
CoVAbDab after pretraining on SAbDab and then report the average neutralization score after ITA
finetuning. The average neutralization probability of original CoVAbDab antibodies is 69.3%.

Original LSTM AR-GNN RefineGNN

CoVAbDab PPL (↓) -  9.40 8.67 **7.86**
Neutralization (↑) 69.3% 72.0% 70.4% **75.2%**

and p2 of neutralizing SARS-CoV-1 and SARS-CoV-2 and our scoring function is f (s) = p2. The
predictor achieved 0.81 test AUROC for SARS-CoV-2 neutralization prediction.

**CDR sequence constraints. Therapeutic antibodies must be free from developability issues such**
as glycosylation and high charges (Raybould et al., 2019). Thus, we include four constraints on a
CDR-H3 sequence s: 1) Its net charge must be between -2.0 and 2.0 (Raybould et al., 2019). The
definition of net charge is given in the appendix. 2) It must not contain the N-X-S/T motif which is
prone to glycosylation. 3) Any amino acid should not repeat more than five times (e.g. SSSSS). 4)
Perplexity of a generated sequence given by LSTM, AR-GNN, and RefineGNN should be all less
than 10. The last two constraints force generated sequences to be realistic. We use all three models
in the perplexity constraint to ensure a fair comparison for all methods.

**Metric. For each antibody in the test set, we generate 100 new CDR-H3 sequences, concatenate**
them with its context sequence to form 100 full VH sequences, and feed them into the neutralization
predictor f . We report the average neutralization score of antibodies in the test set. Neutralization
score of a generated sequence s[′] equals f (s[′]) if it satisfies all the CDR sequence constraints. Otherwise the score is the same as the original sequence. In addition, we pretrain each model on the
SAbDab CDR-H3 sequences and evaluate its PPL on the CoVAbDab CDR-H3 sequences.

**Results. All methods are pretrained on SAbDab antibodies and finetuned on CoVAbDab using the**
ITA algorithm to generate neutralizing antibodies. Our model outperforms the best baseline by a 3%
increase in terms of average neutralization score (Table 2). Our pretrained RefineGNN also achieves
a much lower perplexity on CoVAbDab antibodies (7.86 v.s. 8.67). Examples of generated CDR-H3
sequences and their predicted neutralization scores are shown in the appendix.

5 CONCLUSION

In this paper, we developed a RefineGNN model for antibody sequence and structure co-design.
The advantage of our model over previous graph generation methods is its ability to revise a generated subgraph to accommodate addition of new residues. Our approach significantly outperforms
sequence-based and graph-based approaches on three antibody generation tasks.


-----

ACKNOWLEDGEMENT

We would like to thank Rachel Wu, Xiang Fu, Jason Yim, and Peter Mikhael for their valuable
feedback on the manuscript. We also want to thank Nitan Shalon, Nicholas Webb, Jae Hyeon Lee,
Qiu Yu, and Galit Alter for their suggestions on method development. We are grateful for the
generous support of Mark and Lisa Schwartz, funding in a form of research grant from Sanofi,
Defense Threat Reduction Agency (DTRA), C3.ai Digital Transformation Institute, Eric and Wendy
Schmidt Center at the Broad Institute, Abdul Latif Jameel Clinic for Machine Learning in Health,
DTRA Discovery of Medical Countermeasures Against New and Emerging (DOMANE) threats
program, and DARPA Accelerated Molecular Discovery program.

REFERENCES

Abul K Abbas, Andrew H Lichtman, and Shiv Pillai. Cellular and molecular immunology E-book.
Elsevier Health Sciences, 2014.

Jared Adolf-Bryfogle, Oleks Kalyuzhniy, Michael Kubitz, Brian D Weitzner, Xiaozhen Hu, Yumiko
Adachi, William R Schief, and Roland L Dunbrack Jr. Rosettaantibodydesign (rabd): A general
framework for computational antibody design. PLoS computational biology, 14(4):e1006112,
2018.

Rahmad Akbar, Philippe A Robert, C´edric R Weber, Michael Widrich, Robert Frank, Milena
Pavlovi´c, Lonneke Scheffer, Maria Chernigovskaya, Igor Snapkov, Andrei Slabodkin, et al. In silico proof of principle of machine learning-based antibody design at unconstrained scale. BioRxiv,
2021.

Mohammed M Al Qaraghuli, Karina Kubiak-Ossowska, Valerie A Ferro, and Paul A Mulheran.
Antibody-protein binding and conformational changes: identifying allosteric signalling pathways
to engineer a better effector response. Scientific reports, 10(1):1–10, 2020.

Ethan C Alley, Grigory Khimulya, Surojit Biswas, Mohammed AlQuraishi, and George M Church.
Unified rational protein engineering with sequence-based deep representation learning. Nature
_methods, 16(12):1315–1322, 2019._

Minkyung Baek, Frank DiMaio, Ivan Anishchenko, Justas Dauparas, Sergey Ovchinnikov, Gyu Rie
Lee, Jue Wang, Qian Cong, Lisa N Kinch, R Dustin Schaeffer, et al. Accurate prediction of
protein structures and interactions using a three-track neural network. Science, 373(6557):871–
876, 2021.

Yue Cao, Payel Das, Vijil Chenthamarakshan, Pin-Yu Chen, Igor Melnyk, and Yang Shen. Fold2seq:
A joint sequence (1d)-fold (3d) embedding-based generative model for protein design. In Inter_national Conference on Machine Learning, pp. 1261–1271. PMLR, 2021._

Kyunghyun Cho, Bart Van Merri¨enboer, Caglar Gulcehre, Dzmitry Bahdanau, Fethi Bougares, Holger Schwenk, and Yoshua Bengio. Learning phrase representations using rnn encoder-decoder
for statistical machine translation. arXiv preprint arXiv:1406.1078, 2014.

James Dunbar, Konrad Krawczyk, Jinwoo Leem, Terry Baker, Angelika Fuchs, Guy Georges, Jiye
Shi, and Charlotte M Deane. Sabdab: the structural antibody database. Nucleic acids research,
42(D1):D1140–D1146, 2014.

Sharon Fischman and Yanay Ofran. Computational design of antibodies. Current opinion in struc_tural biology, 51:156–162, 2018._

Niklas WA Gebauer, Michael Gastegger, and Kristof T Sch¨utt. Symmetry-adapted generation of
3d point sets for the targeted discovery of molecules. In Proceedings of the 33rd International
_Conference on Neural Information Processing Systems, pp. 7566–7578, 2019._

Aditya Grover, Aaron Zweig, and Stefano Ermon. Graphite: Iterative generative modeling of graphs.
In International conference on machine learning, pp. 2434–2444. PMLR, 2019.

Steven Henikoff and Jorja G Henikoff. Amino acid substitution matrices from protein blocks. Pro_ceedings of the National Academy of Sciences, 89(22):10915–10919, 1992._


-----

John Ingraham, Adam Riesselman, Chris Sander, and Debora Marks. Learning protein structure
with a differentiable simulator. In International Conference on Learning Representations, 2018.

John Ingraham, Vikas K Garg, Regina Barzilay, and Tommi Jaakkola. Generative models for graphbased protein design. Neural Information Processing Systems, 2019.

Wengong Jin, Regina Barzilay, and Tommi Jaakkola. Hierarchical generation of molecular graphs
using structural motifs. In Proceedings of the 37th International Conference on Machine Learn_ing, volume 119, pp. 4839–4848. PMLR, 2020a._

Wengong Jin, Regina Barzilay, and Tommi Jaakkola. Multi-objective molecule generation using
interpretable substructures. In Proceedings of the 37th International Conference on Machine
_Learning, volume 119, pp. 4849–4859. PMLR, 2020b._

John Jumper, Richard Evans, Alexander Pritzel, Tim Green, Michael Figurnov, Olaf Ronneberger,
Kathryn Tunyasuvunakool, Russ Bates, Augustin Z´[ˇ] ıdek, Anna Potapenko, et al. Highly accurate
protein structure prediction with alphafold. Nature, 596(7873):583–589, 2021.

Wolfgang Kabsch. A solution for the best rotation to relate two sets of vectors. Acta Crystallo_graphica Section A: Crystal Physics, Diffraction, Theoretical and General Crystallography, 32_
(5):922–923, 1976.

Mostafa Karimi, Shaowen Zhu, Yue Cao, and Yang Shen. De novo protein design for novel folds
using guided conditional wasserstein generative adversarial networks. Journal of Chemical Infor_mation and Modeling, 60(12):5667–5681, 2020._

Gideon D Lapidoth, Dror Baran, Gabriele M Pszolla, Christoffer Norn, Assaf Alon, Michael D
Tyka, and Sarel J Fleishman. Abdesign: A n algorithm for combinatorial backbone design guided
by natural conformations and sequences. Proteins: Structure, Function, and Bioinformatics, 83
(8):1385–1406, 2015.

Andrew Leaver-Fay, Michael Tyka, Steven M Lewis, Oliver F Lange, James Thompson, Ron Jacak,
Kristian W Kaufman, P Douglas Renfrew, Colin A Smith, Will Sheffler, et al. Rosetta3: an objectoriented software suite for the simulation and design of macromolecules. Methods in enzymology,
487:545–574, 2011.

Marie-Paule Lefranc, Christelle Pommi´e, Manuel Ruiz, V´eronique Giudicelli, Elodie Foulquier,
Lisa Truong, Val´erie Thouvenin-Contet, and G´erard Lefranc. Imgt unique numbering for immunoglobulin and t cell receptor variable domains and ig superfamily v-like domains. Develop_mental & Comparative Immunology, 27(1):55–77, 2003._

Tao Lei. When attention meets fast recurrence: Training language models with reduced compute.
_arXiv preprint arXiv:2102.12459, 2021._

Tong Li, Robert J Pantazes, and Costas D Maranas. Optmaven–a new framework for the de novo
design of antibody variable region models targeting specific antigen epitopes. PloS one, 9(8):
e105954, 2014.

Yujia Li, Oriol Vinyals, Chris Dyer, Razvan Pascanu, and Peter Battaglia. Learning deep generative
models of graphs. arXiv preprint arXiv:1803.03324, 2018.

Renjie Liao, Yujia Li, Yang Song, Shenlong Wang, Will Hamilton, David K Duvenaud, Raquel
Urtasun, and Richard Zemel. Efficient graph generation with graph recurrent attention networks.
_Advances in Neural Information Processing Systems, 32:4255–4265, 2019._

Ge Liu, Haoyang Zeng, Jonas Mueller, Brandon Carter, Ziheng Wang, Jonas Schilz, Geraldine
Horny, Michael E Birnbaum, Stefan Ewert, and David K Gifford. Antibody complementarity
determining region design using high-capacity machine learning. Bioinformatics, 36(7):2126–
2133, 2020.

Qi Liu, Miltiadis Allamanis, Marc Brockschmidt, and Alexander L Gaunt. Constrained graph variational autoencoders for molecule design. Neural Information Processing Systems, 2018.


-----

Shitong Luo and Wei Hu. Diffusion probabilistic models for 3d point cloud generation. In Proceed_ings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition, pp. 2837–2845,_
2021.

James O’Connell, Zhixiu Li, Jack Hanson, Rhys Heffernan, James Lyons, Kuldip Paliwal, Abdollah
Dehzangi, Yuedong Yang, and Yaoqi Zhou. Spin2: Predicting sequence profiles from protein
structures using deep neural networks. Proteins: Structure, Function, and Bioinformatics, 86(6):
629–633, 2018.

RJ Pantazes and Costas D Maranas. Optcdr: a general computational method for the design of
antibody complementarity determining regions for targeted epitope binding. Protein Engineering,
_Design & Selection, 23(11):849–858, 2010._

Dora Pinto, Young-Jun Park, Martina Beltramello, Alexandra C Walls, M Alejandra Tortorici, Siro
Bianchi, Stefano Jaconi, Katja Culap, Fabrizia Zatta, Anna De Marco, et al. Cross-neutralization
of sars-cov-2 by a human monoclonal sars-cov antibody. Nature, 583(7815):290–295, 2020.

Matthew IJ Raybould, Claire Marks, Konrad Krawczyk, Bruck Taddese, Jaroslaw Nowak, Alan P
Lewis, Alexander Bujotzek, Jiye Shi, and Charlotte M Deane. Five computational developability
guidelines for therapeutic antibody profiling. Proceedings of the National Academy of Sciences,
116(10):4025–4030, 2019.

Matthew IJ Raybould, Aleksandr Kovaltsuk, Claire Marks, and Charlotte M Deane. Cov-abdab: the
coronavirus antibody database. Bioinformatics, 37(5):734–735, 2021.

Koichiro Saka, Taro Kakuzaki, Shoichi Metsugi, Daiki Kashiwagi, Kenji Yoshida, Manabu Wada,
Hiroyuki Tsunoda, and Reiji Teramoto. Antibody design using lstm based deep generative model
from phage display library for affinity maturation. Scientific reports, 11(1):1–13, 2021.

Chence Shi, Shitong Luo, Minkai Xu, and Jian Tang. Learning gradient fields for molecular conformation generation. International Conference on Machine Learning, 2021.

Jung-Eun Shin, Adam J Riesselman, Aaron W Kollasch, Conor McMahon, Elana Simon, Chris
Sander, Aashish Manglik, Andrew C Kruse, and Debora S Marks. Protein design and variant
prediction using autoregressive generative models. Nature communications, 12(1):1–11, 2021.

Martin Steinegger and Johannes S¨oding. Mmseqs2 enables sensitive protein sequence searching for
the analysis of massive data sets. Nature biotechnology, 35(11):1026–1028, 2017.

Alexey Strokach, David Becerra, Carles Corbi-Verge, Albert Perez-Riba, and Philip M Kim. Fast
and flexible design of novel proteins using graph neural networks. BioRxiv, pp. 868935, 2020.

Doug Tischer, Sidney Lisanza, Jue Wang, Runze Dong, Ivan Anishchenko, Lukas F Milles, Sergey
Ovchinnikov, and David Baker. Design of proteins presenting discontinuous functional sites using
deep learning. bioRxiv, 2020.

Jianyi Yang, Ivan Anishchenko, Hahnbeom Park, Zhenling Peng, Sergey Ovchinnikov, and David
Baker. Improved protein structure prediction using predicted interresidue orientations. Proceed_ings of the National Academy of Sciences, 117(3):1496–1503, 2020a._

Kevin Yang, Wengong Jin, Kyle Swanson, Regina Barzilay, and Tommi Jaakkola. Improving molecular design by stochastic iterative target augmentation. In International Conference on Machine
_Learning, pp. 10716–10726. PMLR, 2020b._

Jiaxuan You, Rex Ying, Xiang Ren, William L Hamilton, and Jure Leskovec. Graphrnn: A deep
generative model for graphs. International Conference on Machine Learning, 2018.


-----

A MODEL ARCHITECTURE DETAILS

A.1 REFINEGNN

**Node features. Each node feature vi encodes three dihedral angles as follows.**

**_vi = (cos φi, cos ψi, cos ωi, sin φi, sin ψi, sin ωi)_** (16)

each residueEdge features. i (Ingraham et al., 2019), which is calculated as The orientation matrix Oi = [bi, ni, bi × ni] defines a local coordinate system for

**_ui =_** **_xi −_** **_xi−1_** **_bi =_** **_ui −_** **_ui+1_** **_ni =_** **_ui × ui+1_** (17)

_∥xi −_ **_xi−1∥_** _[,]_ _∥ui −_ **_ui+1∥_** _[,]_ _∥ui × ui+1∥_

**Attention mechanism. The attention layer used in Eq.(13) is a standard bilinear attention:**


exp(c[⊤]i **_[W h][t][)]_**
_αi,tci,_ _αi,t =_ (18)

_j_ [exp(][c]j[⊤][W h][t][)]

P


attention(c1:n, ht) =

A.2 AR-GNN


AR-GNN generates an antibody graph autoregressively. In each generation step t, AR-GNN learns
to encode the current subgraph G1:t induced from residues {s1, · · ·, st} into a list of vectors

**_h1,_** _, ht_ = MPNθ( 1:t). (19)
_{_ _· · ·_ _}_ _G_

For fair comparison, we use the same MPN architecture for both RefineGNN and AR-GNN. In
terms of structure prediction, AR-GNN first predicts the node feature ˆvt+1 of the next residue t + 1,
namely the dihedral angle between its three atoms Cα, C, N .

**_vˆt+1 = Wvht_** (20)


In addition, AR-GNN predicts the pairwise distance between st+1 and previous residues s1, · · ·, st.
**_dˆi,t+1 = FFN(Wdhi + Udht + VdEpos(t + 1 −_** _i)),_ (21)

where FFN is a feed-forward network with one hidden layer and Epos is the positional encoding of
_t + 1 −_ _i, the gap between residue st+1 and si in the sequence. Lastly, AR-GNN predicts the amino_
acid type of residue st+1 by

**_pˆt+1 = softmax(Wagt+1),_** **_g1,_** _, gt+1_ = MPNθ′ ( 1:t+1) (22)
_{_ _· · ·_ _}_ _G_

Note that AR-GNN also uses two separate MPNs for structure and sequence prediction. However,
unlike RefineGNN, AR-GNN is trained under teacher forcing — we need to feed it the ground
truth structure and sequence in each generation step. In particular, we find data augmentation to
be crucial for AR-GNN performance. Data augmentation is essential because of the discrepancy
between training and testing. The model is trained under teacher forcing, but it needs to decode a
graph without teacher forcing at test time. We find mistakes made in previous steps have a great
impact on subsequent predictions during decoding.

Specifically, for every antibody s, we create a corrupted graph _G by adding independent random_
Gaussian noise to every coordinate: ˜xi = xi + 3ϵ, ϵ ∼N (0, I). In each generation step, we apply
MPN over the corrupted graph instead.

[e]

**_h1,_** _,_ **_ht_** = MPNθ( 1:t), **_g1,_** _,_ **_gt+1_** = MPNθ′ ( 1:t+1) (23)
_{[e]_ _· · ·_ _}_ _G_ _{_ _· · ·_ _}_ _G_

The node and edge labels are still defined by the ground truth structure. Specifically, let vt and di,j
be the ground truth dihedral angle and pairwise distance calculated from the original, uncorrupted[e] [e] e e [e]
graph G. AR-GNN loss function is defined as the following.

_LAR =_ _i,j_ _∥d[ˆ]i,j −_ **_di,j∥[2]_** + _t_ _∥vˆt −_ **_vt∥[2]_** + Lce(ˆpt, st) (24)
X X

Similar to RefineGNN, AR-GNN also uses attention mechanism for conditional generation. Specifically, we concatenate the residue representations **_ht,_** **_gt from MPN with context vectors learned_**
from an attention layer.
**_ht_** **_ht_** attention(c1:n, **_ht)_** [e]gt e **_gt_** attention(c1:n, **_gt)_** (25)
e _←_ [e] _⊕_ [e] e _←_ e _⊕_ e


-----

Table 3: SARS-CoV-2 neutralization optimization results. Here we show examples of new CDRH3 sequences generated by our model and their predicted neutralization improvement over original
antibodies S1D7 and C694 in the CoVAbDab database.

Antibody: S1D7 C694

Old CDR-H3 TRGHSDY ARDRGYDSSGPDAFDI
New CDR-H3 ARWWMDV ARERIIIVSISAWMDV
Improvement 63% → 73% 82% → 91%

B EXPERIMENTAL DETAILS

**Hyperparameters.and number of message passing layers For AR-GNN and RefineGNN, we tried hidden dimension L ∈{1, 2, 3, 4, 5}. We found dh = 256 d, Lh ∈{ = 4128 worked, 256}**
the best for RefineGNN and dh = 256, L = 3 worked the best for AR-GNN. For LSTM, we tried
Adam optimizer with a dropout of 0.1 and a learning rate of 0.001.dh ∈{128, 256, 512, 1024}. We found dh = 256 worked the best. All models are trained by an

**SAbDab data. The dataset statistics of SAbDab is the following (after deduplication). For CDR-**
H1, the train/validation/test size is 4050, 359, and 326. For CDR-H2, the train/validation/test size is
3876, 483, and 376. For CDR-H3, the train/validation/test size is 3896, 403, and 437.

Since SAbDab includes both bound and unbound structures, we removed all antigens and used the
bound antibody structure for training. Specifically, 65% of our training data came from bound
state structures. We included all data in our training set because the mismatch between bound and
unbound structures is relatively small. In fact, Al Qaraghuli et al. (2020) studied eight antibodies
and found that the RMSD between bound and unbound structures over VH domains is less than 0.7
on average.

**RAbD configuration. We provided details of the de novo design setup of RosettaAntibodyDesign**
(RAbD) here. For each antibody in the test set, RAbD starts by randomly selecting a CDR from
RAbD’s internal database of known CDR structures. The chosen CDR-H3 sequence is required to
have same length as the original sequence, but it cannot be exactly the same as the original CDR-H3
sequence. After the initial CDR structure is chosen, RAbD grafts it onto the antibody and performs
energy minimization to stabilize its structure. Next, RAbD runs 100 iterations of sequence design
to modify the grafted CDR-H3 structure by randomly substituting amino acids. In each sequence
design iteration, it performs energy minimization to adjust the structure according to the changed
amino acid. Lastly, the model returns the generated CDR-H3 sequence with the lowest energy.

**SARS-CoV-2 neutralization. Each generative model is pretrained on the SAbDab data to learn a**
prior distribution over CDR-H3 structures. Given a fixed predictor f, we use the ITA algorithm to
finetune our pretrained models to generate neutralizing antibodies. Each model is trained for 3000
ITA steps with M = 100. Generated CDR-H3 sequences from our model are visualized in Table 3.

Our neutralization predictor f is trained on the CoVAbDab database. For simplicity, we only consider two viruses, SARS-CoV-1 and SARS-CoV-2 since other coronavirus have very little training
data. For the same reason, we only consider the spike protein receptor binding domain as our target
epitope. The predictor is trained in a multi-task fashion to predict both SARS-CoV-1 and SARSCoV-2 neutralization labels. The SRU encoder has a hidden dimension of 256. The model was
trained with a dropout of 0.2, a learning rate of 0.0005, and batch size of 16.

(Raybould et al., 2019). The net charge of a sequenceThe charge of a residue is defined as C(si) = I[si ∈{ sR, K1 · · · s}] + 0n is defined as.1 · I[si = Hi][C] −[(][s]I[i][s[)][.]i ∈{D, E}]

[P]


-----

